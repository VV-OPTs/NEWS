<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>类报纸排版生成器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;700&family=Playfair+Display:wght@700&family=Roboto:wght@400;700&family=Source+Code+Pro:wght@400;700&family=Comic+Neue:wght@700&family=Times+New+Roman&family=Courier+New&family=Arial&display=swap" rel="stylesheet">
    <style>
        * {margin: 0;padding: 0;box-sizing: border-box;}
        body {font-family: 'Noto Serif SC', serif;background-color: #f5f1e8;
            color: #333;line-height: 1.6;padding: 20px;}
        .container {max-width: 1600px;margin: 0 auto;display: flex;
            flex-direction: column;gap: 30px;}
        header {text-align: center;padding: 20px 0;border-bottom: 2px solid #8c2e2e;}
        h1 {font-family: 'Playfair Display', serif;color: #8c2e2e;font-size: 2.8rem;
            letter-spacing: 2px;margin-bottom: 10px;}
        .subtitle {font-size: 1.2rem;color: #666;font-style: italic;}
        .main-content {display: flex;flex-wrap: wrap;gap: 30px;}
        .editor-panel {flex: 1;min-width: 500px;background-color: #fff;
            padding: 25px;border-radius: 5px;box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-top: 8px solid #8c2e2e;max-height: 95vh;overflow-y: auto;}
        .newspaper-preview {flex: 2;min-width: 700px;
            background-color: #fff;padding: 40px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            position: relative;background-color: #faf8f2;}
        
        /* 布局切换样式 */
        .layout-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 15px;
            gap: 10px;
        }
        .layout-btn {
            padding: 8px 15px;
            background-color: #e0d6c2;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Noto Serif SC', serif;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        .layout-btn:hover {
            background-color: #d4c9b8;
        }
        .layout-btn.active {
            background-color: #8c2e2e;
            color: white;
        }
        .vertical-layout .main-content {
            flex-direction: column;
        }
        .vertical-layout .editor-panel,
        .vertical-layout .newspaper-preview {
            min-width: 100%;
            max-height: none;
        }
        
        .section-title {font-size: 1.4rem;color: #8c2e2e;margin-bottom: 20px;
            padding-bottom: 10px;border-bottom: 1px solid #e0d6c2;
            display: flex;align-items: center;gap: 10px;}
        .section-title i {font-size: 1.2rem;}
        .control-group {margin-bottom: 25px;padding: 15px;
            border-radius: 8px;background-color: #f9f7f1;}
        .control-group-image {background-color: #f0f7f0;}
        .control-group-header {background-color: #e6f0f6;}
        .control-group-title {background-color: #f0e6d6;}
        .control-group-text {background-color: #f0f4f8;}
        .control-group-footer {background-color: #f5f0e8;}
        .control-group-header-content {display: flex;
            justify-content: space-between;align-items: center;margin-bottom: 15px;}
        .control-group-header h3 {font-size: 1.1rem;color: #444;display: flex;
            align-items: center;gap: 8px;}
        .toggle-switch {position: relative;display: inline-block;width: 50px;height: 24px;}
        .toggle-switch input {opacity: 0;width: 0;height: 0;}
        .toggle-slider {position: absolute;cursor: pointer;top: 0;left: 0;right: 0;bottom: 0;
            background-color: #ccc;transition: .4s;border-radius: 24px;}
        .toggle-slider:before {position: absolute;content: "";height: 16px;
            width: 16px;left: 4px;bottom: 4px;background-color: white;
            transition: .4s;border-radius: 50%;}
        input:checked + .toggle-slider {background-color: #8c2e2e;}
        input:checked + .toggle-slider:before {transform: translateX(26px);}
        .control-row {display: flex;gap: 15px;margin-bottom: 15px;align-items: center;
            flex-wrap: wrap;}
        .control-item {flex: 1;min-width: 180px;}
        label {display: block;margin-bottom: 8px;font-weight: bold;color: #444;
            font-size: 0.95rem;}
        input[type="text"], textarea, select {width: 100%;padding: 10px;
            border: 1px solid #d4c9b8;border-radius: 4px;
            font-family: 'Noto Serif SC', serif;font-size: 1rem;
            background-color: #fff;transition: border-color 0.3s;}
        input[type="text"]:focus, textarea:focus, select:focus {outline: none;
            border-color: #8c2e2e;}
        textarea {min-height: 150px;resize: vertical;}
        .image-upload {border: 2px dashed #d4c9b8;border-radius: 4px;
            padding: 20px;text-align: center;cursor: pointer;transition: border-color 0.3s;
            background-color: #f9f7f1;}
        .image-upload:hover {border-color: '#8c2e2e';}
        .image-upload i {font-size: 2.5rem;color: #8c2e2e;margin-bottom: 10px;}
        #imagePreview {max-width: 100%;max-height: 200px;margin-top: 15px;display: none;}
        .font-size-control {display: flex;align-items: center;gap: 15px;}
        .font-size-control input {flex: 1;}
        .color-picker-container {display: flex;align-items: center;gap: 10px;}
        .color-picker {width: 50px;height: 40px;border: 1px solid #d4c9b8;
            border-radius: 4px;cursor: pointer;background-color: #fff;}
        .size-value, .color-value {font-weight: bold;color: #8c2e2e;min-width: 40px;
            font-size: 0.9rem;}
        .buttons {display: flex;gap: 15px;margin-top: 30px;}
        button {padding: 14px 24px;border: none;border-radius: 4px;
            font-family: 'Noto Serif SC', serif;font-size: 1rem;font-weight: bold;
            cursor: pointer;transition: all 0.3s;flex: 1;display: flex;
            align-items: center;justify-content: center;gap: 10px;}
        .generate-btn {background-color: #8c2e2e;color: white;}
        .generate-btn:hover {background-color: #6d2323;transform: translateY(-2px);}
        .download-btn {background-color: #2e5d8c;color: white;}
        .download-btn:hover {background-color: #24496e;transform: translateY(-2px);}
        .reset-btn {background-color: #e0d6c2;color: #333;}
        .reset-btn:hover {background-color: #d4c9b8;}
        
        /* 保存和加载按钮样式 */
        .save-btn {background-color: #2e8c5d;color: white;}
        .save-btn:hover {background-color: #247349;transform: translateY(-2px);}
        .load-btn {background-color: #8c5d2e;color: white;}
        .load-btn:hover {background-color: #6d4923;transform: translateY(-2px);}
        
        /* 富文本编辑按钮样式 */
        .rich-text-toggle-btn {
            margin-top: 10px;
            padding: 10px 15px;
            background-color: #8c2e2e;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Noto Serif SC', serif;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s;
            width: 100%;
        }
        
        .rich-text-toggle-btn:hover {
            background-color: #6d2323;
            transform: translateY(-2px);
        }
        
        /* 富文本编辑器样式 */
        .rich-text-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .rich-text-btn {
            padding: 8px 12px;
            background-color: #e0d6c2;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Noto Serif SC', serif;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .rich-text-btn:hover {
            background-color: #d4c9b8;
        }
        
        .rich-text-btn.active {
            background-color: #8c2e2e;
            color: white;
        }
        
        .rich-text-editor {
            border: 1px solid #d4c9b8;
            border-radius: 4px;
            padding: 15px;
            min-height: 300px;
            background-color: white;
            overflow-y: auto;
            font-family: 'Noto Serif SC', serif;
            line-height: 1.6;
            outline: none;
        }
        
        .rich-text-editor:focus {
            border-color: #8c2e2e;
        }
        
        .rich-text-editor h3 {
            color: #8c2e2e;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0d6c2;
            font-size: 1.3em;
            font-weight: bold;
        }
        
        .rich-text-editor p {
            margin-bottom: 15px;
            text-indent: 2em;
        }
        
        .rich-text-editor img {
            max-width: 100%;
            height: auto;
            margin: 15px auto;
            display: block;
            border: 1px solid #d4c9b8;
            padding: 5px;
            background-color: white;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .image-inline {
            display: inline-block;
            vertical-align: middle;
            margin: 0 5px;
            max-height: 100px;
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 900px;
            max-height: 90vh;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0d6c2;
        }
        
        .modal-header h3 {
            color: #8c2e2e;
            margin: 0;
        }
        
        .modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e0d6c2;
        }
        
        .modal-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Noto Serif SC', serif;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .modal-btn-primary {
            background-color: #8c2e2e;
            color: white;
        }
        
        .modal-btn-primary:hover {
            background-color: #6d2323;
        }
        
        .modal-btn-secondary {
            background-color: #e0d6c2;
            color: #333;
        }
        
        .modal-btn-secondary:hover {
            background-color: #d4c9b8;
        }
        
        .image-upload-area {
            border: 2px dashed #d4c9b8;
            border-radius: 4px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: border-color 0.3s;
            background-color: #f9f7f1;
            margin-bottom: 20px;
        }
        
        .image-upload-area:hover {
            border-color: #8c2e2e;
        }
        
        .image-upload-area i {
            font-size: 3rem;
            color: #8c2e2e;
            margin-bottom: 15px;
        }
        
        .image-upload-area p {
            margin: 0;
            color: #666;
        }
        
        .image-preview-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }
        
        .image-preview-item {
            width: 120px;
            height: 120px;
            border: 1px solid #d4c9b8;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .image-preview-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .image-preview-item .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .current-image-count {
            text-align: center;
            color: #666;
            font-size: 0.9rem;
            margin-top: 10px;
        }
        
        /* 报纸样式 */
        .newspaper {font-family: 'Noto Serif SC', serif;background-color: #faf8f2;
            padding: 40px;border: 1px solid #d4c9b8;
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.05);
            min-height: 800px;position: relative;overflow: hidden;transition: all 0.3s ease;}
        .newspaper::before {content: "";position: absolute;top: 0;left: 0;right: 0;bottom: 0;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M11 18c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm48 25c3.866 0 7-3.134 7-7s-3.134-7-7-7-7 3.134-7 7 3.134 7 7 7zm-43-7c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm63 31c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM34 90c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zm56-76c1.657 0 3-1.343 3-3s-1.343-3-3-3-3 1.343-3 3 1.343 3 3 3zM12 86c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm28-65c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm23-11c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-6 60c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm29 22c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zM32 63c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm57-13c2.76 0 5-2.24 5-5s-2.24-5-5-5-5 2.24-5 5 2.24 5 5 5zm-9-21c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM60 91c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM35 41c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2zM12 60c1.105 0 2-.895 2-2s-.895-2-2-2-2 .895-2 2 .895 2 2 2z' fill='%23d4c9b8' fill-opacity='0.2' fill-rule='evenodd'/%3E%3C/svg%3E");
            opacity: 0.3;z-index: 0;}
        .newspaper-content {position: relative;z-index: 1;}
        .newspaper-header {border-bottom: 3px double #8c2e2e;padding-bottom: 15px;
            margin-bottom: 30px;text-align: center;}
        .paper-name {font-family: 'Playfair Display', serif;font-size: 3.5rem;
            letter-spacing: 3px;color: #222;margin-bottom: 5px;}
        .paper-date {font-style: italic;color: #666;font-size: 1.1rem;}
        .article-title {font-size: 2.5rem;font-weight: bold;line-height: 1.2;
            margin-bottom: 25px;color: #222;text-align: center;
            font-family: 'Playfair Display', serif;}
        .article-content {display: flex;flex-wrap: wrap;gap: 30px;margin-top: 30px;}
        .article-image-container {flex: 1;min-width: 300px;}
        .article-image {width: 100%;height: auto;border: 1px solid #d4c9b8;
            padding: 5px;background-color: white;box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);}
        .article-image-caption {font-size: 0.9rem;color: #666;font-style: italic;text-align: center;
            margin-top: 8px;padding-top: 8px;border-top: 1px dotted #d4c9b8;}
        .article-text {flex: 2;min-width: 300px;
            text-align: justify;hyphens: auto;}
        /* 电脑端默认显示双栏，手机端单栏 */
        .article-text {
            column-count: 2;
            column-gap: 30px;
        }
        .article-text.no-image {flex: 1;min-width: 100%;}
        .article-text p {margin-bottom: 15px;text-indent: 2em;}
        /* 文章中小标题样式 */
        .article-text h3 {
            color: #8c2e2e;
            margin: 20px 0 10px 0;
            padding-bottom: 5px;
            border-bottom: 1px solid #e0d6c2;
            font-size: 1.3em;
            font-weight: bold;
            column-span: all;
        }
        /* 文章中图片样式 */
        .article-text .inline-image {
            margin: 15px auto;
            text-align: center;
            column-span: all;
        }
        .article-text .inline-image img {
            max-width: 100%;
            height: auto;
            border: 1px solid #d4c9b8;
            padding: 5px;
            background-color: white;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* 文章中富文本样式 */
        .article-text b, .article-text strong {
            font-weight: bold;
        }
        
        .article-text i, .article-text em {
            font-style: italic;
        }
        
        .article-text u {
            text-decoration: underline;
        }
        
        .article-text ul, .article-text ol {
            margin: 10px 0 10px 2em;
            padding: 0;
        }
        
        .article-text li {
            margin-bottom: 5px;
        }
        
        .newspaper-footer {margin-top: 40px;padding-top: 20px;
            border-top: 1px solid #d4c9b8;font-size: 0.9rem;color: #666;text-align: center;}
        .generated-date {font-style: italic;}
        
        /* 噪点纹理层 */
        .newspaper.has-noise::after {
            content: "";
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            pointer-events: none;
            z-index: 5;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)' opacity='0.5'/%3E%3C/svg%3E");
            opacity: 0.4;
            mix-blend-mode: multiply;
        }

        /* 图片位置切换布局样式 */
        .article-content.layout-column { flex-direction: column; }
        .article-content.layout-row { flex-direction: row; align-items: flex-start; }
        .article-content.layout-row-reverse { flex-direction: row-reverse; align-items: flex-start; }
        
        /* ===== 修复上图下文布局遮挡问题 ===== */
        .article-content.layout-column .article-image-container,
        .article-content.layout-column .article-text {
            flex: none;          /* 取消flex比例，避免干扰高度 */
            width: 100%;         /* 确保宽度占满父容器 */
            max-width: 100%;
        }
        .article-content.layout-column .article-image-container {
            margin-bottom: 30px; /* 与gap保持一致，确保图片与文字之间有明确间距 */
        }
        /* ==================================== */
        
        @media (max-width: 768px) {
            .main-content {flex-direction: column;}
            .editor-panel, .newspaper-preview {min-width: 100%;}
            .article-text {
                column-count: 1 !important;
                column-gap: 0 !important;
            }
            .article-title {font-size: 2rem;}
            .paper-name {font-size: 2.5rem;}
            .layout-controls {justify-content: center;}
            .layout-btn {font-size: 0.8rem;padding: 6px 10px;}
            .buttons {flex-wrap: wrap;}
            .buttons button {min-width: calc(50% - 7.5px);}
            
            /* 手机端模态框调整 */
            .modal-content {padding: 15px;}
            .rich-text-btn {font-size: 0.8rem;padding: 6px 8px;}
            .image-preview-item {width: 80px;height: 80px;}
        }
        
        /* 错误弹窗样式 */
        .error-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .error-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        .error-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            color: #d32f2f;
            font-size: 1.5rem;
        }
        .error-header i {
            margin-right: 10px;
            font-size: 1.8rem;
        }
        .error-details {
            background-color: #f9f7f1;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #d32f2f;
        }
        .error-solution {
            background-color: #f0f7f0;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #2e8c5d;
        }
        .error-solution h4 {
            color: #2e8c5d;
            margin-bottom: 10px;
        }
        .error-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 25px;
        }
        .error-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-family: 'Noto Serif SC', serif;
            font-weight: bold;
            transition: all 0.3s;
        }
        .error-btn-primary {
            background-color: #8c2e2e;
            color: white;
        }
        .error-btn-primary:hover {
            background-color: #6d2323;
        }
        .error-btn-secondary {
            background-color: #e0d6c2;
            color: #333;
        }
        .error-btn-secondary:hover {
            background-color: #d4c9b8;
        }
        
        .toast {position: fixed;bottom: 20px;right: 20px;background-color: #2e8c5d;
            color: white;padding: 15px 25px;border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);display: none;
            z-index: 1000;font-weight: bold;}
        footer {text-align: center;margin-top: 30px;padding-top: 20px;
            border-top: 1px solid #d4c9b8;color: #666;font-size: 0.9rem;}
        
        /* 字体预览样式 */
        .font-preview {margin-top: 5px;padding: 5px;
            font-size: 0.9rem;border-radius: 4px;background-color: #fff;
            border: 1px dashed #ddd;min-height: 30px;}
        
        /* 颜色预览 */
        .color-preview {width: 100%;height: 8px;border-radius: 4px;margin-top: 5px;}
        
        /* 小标题 */
        .control-subtitle {font-size: 0.9rem;color: #666;margin-top: -10px;margin-bottom: 15px;
            font-style: italic;}
        .image-control-header {display: flex;justify-content: space-between;
            align-items: center;margin-bottom: 15px;}
        .image-control-header h3 {margin: 0;font-size: 1.1rem;
            color: #444;display: flex;align-items: center;gap: 8px;}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1><i class="fas fa-newspaper"></i> 类报纸排版生成器</h1>
            <p class="subtitle">工具制作：@村里最乱炒的坏厨</p>
        </header>
        
        <!-- 布局控制按钮 -->
        <div class="layout-controls">
            <button id="horizontalLayoutBtn" class="layout-btn active">
                <i class="fas fa-columns"></i> 左右布局
            </button>
            <button id="verticalLayoutBtn" class="layout-btn">
                <i class="fas fa-stream"></i> 上下布局
            </button>
        </div>
        
        <div class="main-content">
            <div class="editor-panel">
                <h2 class="section-title"><i class="fas fa-sliders-h"></i> 自定义设置</h2>
                <div class="control-group control-group-image">
                    <div class="image-control-header">
                        <h3><i class="fas fa-image"></i> 图片设置</h3>
                        <div>
                            <span style="margin-right: 10px; font-size: 0.9rem;">显示图片</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="imageVisible" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="control-subtitle">控制是否在报纸中显示图片</div>
                    
                    <!-- 噪点开关、图片位置切换和强制导出设置 -->
                    <div class="control-row">
                        <div class="control-item">
                            <label>整体质感</label>
                            <label class="checkbox-group" style="display:flex;align-items:center;gap:5px;cursor:pointer;">
                                <input type="checkbox" id="paperNoise"> 旧报纸噪点
                            </label>
                        </div>
                        <div class="control-item">
                            <label>图片位置</label>
                            <select id="imageLayout">
                                <option value="column">上图下文</option>
                                <option value="row" selected>默认 (左图右文)</option>
                                <option value="row-reverse">右图左文</option>
                            </select>
                        </div>
                        <div class="control-item">
                            <label>导出模式</label>
                            <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:0.9rem;margin-top:8px;">
                                <input type="checkbox" id="forceDesktopExport" checked> 强制电脑版布局导出
                            </label>
                        </div>
                    </div>
                    
                    <!-- 手机版布局导出复选框 -->
                    <div class="control-row">
                        <div class="control-item">
                            <label>手机版导出</label>
                            <label style="display:flex;align-items:center;gap:5px;cursor:pointer;font-size:0.9rem;margin-top:8px;">
                                <input type="checkbox" id="forceMobileExport"> 强制手机版布局导出
                            </label>
                        </div>
                        <div class="control-item">
                            <!-- 占位符，保持布局 -->
                        </div>
                        <div class="control-item">
                            <!-- 占位符，保持布局 -->
                        </div>
                    </div>
                    
                    <label for="imageUpload">上传图片</label>
                    <div class="image-upload" id="imageUpload">
                        <i class="fas fa-image"></i>
                        <p>点击此处上传图片，或拖放图片文件</p>
                        <input type="file" id="imageInput" accept="image/*" style="display: none;">
                        <img id="imagePreview" alt="预览">
                    </div>
                    <div class="control-row" style="margin-top: 15px;">
                        <div class="control-item">
                            <label for="imageCaption">图片说明文字</label>
                            <input type="text" id="imageCaption" placeholder="请输入图片说明文字..." value="上面可以插入图片，这里可以输入图片备注（当然吐槽碎碎念也没问题。">
                        </div>
                    </div>
                </div>
                
                <!-- 背景颜色自定义控制组 -->
                <div class="control-group control-group-image">
                    <div class="image-control-header">
                        <h3><i class="fas fa-fill-drip"></i> 背景颜色自定义</h3>
                    </div>
                    <div class="control-subtitle">自定义报纸的背景颜色</div>
                    
                    <div class="control-row">
                        <div class="control-item">
                            <label for="backgroundColor">背景颜色</label>
                            <div class="color-picker-container">
                                <input type="color" id="backgroundColor" class="color-picker" value="#faf8f2">
                                <span id="backgroundColorValue" class="color-value">#faf8f2</span>
                            </div>
                            <div id="backgroundColorPreview" class="color-preview" style="background-color: #faf8f2;"></div>
                        </div>
                        <div class="control-item">
                            <label for="borderColor">边框颜色</label>
                            <div class="color-picker-container">
                                <input type="color" id="borderColor" class="color-picker" value="#d4c9b8">
                                <span id="borderColorValue" class="color-value">#d4c9b8</span>
                            </div>
                            <div id="borderColorPreview" class="color-preview" style="background-color: #d4c9b8;"></div>
                        </div>
                        <div class="control-item">
                            <label>&nbsp;</label>
                            <button id="resetBackgroundBtn" class="rich-text-btn" style="width: 100%; margin-top: 8px;">
                                <i class="fas fa-undo"></i> 重置背景
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="control-group control-group-header">
                    <div class="control-group-header-content">
                        <h3><i class="fas fa-newspaper"></i> 报纸头部设置</h3>
                        <div>
                            <span style="margin-right: 10px; font-size: 0.9rem;">显示头部</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="headerVisible" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="control-subtitle">自定义报纸头部（报头、期号、日期等）</div>
                    <div class="control-row">
                        <div class="control-item">
                            <label for="paperName">报纸名称</label>
                            <input type="text" id="paperName" placeholder="请输入报纸名称..." value="XX日报">
                        </div>
                        <div class="control-item">
                            <label for="paperNameFontSize">名称字号：<span id="paperNameSizeValue" class="size-value">56</span>px</label>
                            <div class="font-size-control">
                                <input type="range" id="paperNameFontSize" min="24" max="96" value="56">
                            </div>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-item">
                            <label for="paperNameFontFamily">名称字体</label>
                            <select id="paperNameFontFamily">
                                <option value="'Playfair Display', serif">古典衬线体</option>
                                <option value="'Times New Roman', serif">Times New Roman</option>
                                <option value="'Noto Serif SC', serif">思源宋体</option>
                                <option value="'Roboto', sans-serif">现代无衬线体</option>
                                <option value="'Courier New', monospace">打字机体</option>
                                <option value="'Comic Neue', cursive">手写体</option>
                            </select>
                            <div id="paperNameFontPreview" class="font-preview">报纸名称字体预览</div>
                        </div>
                        <div class="control-item">
                            <label for="paperNameColor">名称颜色</label>
                            <div class="color-picker-container">
                                <input type="color" id="paperNameColor" class="color-picker" value="#222222">
                                <span id="paperNameColorValue" class="color-value">#222222</span>
                            </div>
                            <div id="paperNameColorPreview" class="color-preview" style="background-color: #222222;"></div>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-item">
                            <div style="display:flex;justify-content:space-between;align-items:center;">
                                <label for="paperDateText" style="margin-bottom:0;">报纸期号与日期</label>
                                <label style="font-size:0.8rem;cursor:pointer;"><input type="checkbox" id="paperDateVisible" checked> 显示</label>
                            </div>
                            <div style="margin-top:8px;"></div>
                            <input type="text" id="paperDateText" placeholder="请输入期号和日期..." value="第XXXX期 · XXXX专刊 · XXXX年XX月XX日（这里依然也是可以碎碎念，写'作者xxx'也可以，什么都行）">
                        </div>
                        <div class="control-item">
                            <label for="paperDateFontSize">期号字号：<span id="paperDateSizeValue" class="size-value">18</span>px</label>
                            <div class="font-size-control">
                                <input type="range" id="paperDateFontSize" min="12" max="36" value="18">
                            </div>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-item">
                            <label for="paperDateFontFamily">期号字体</label>
                            <select id="paperDateFontFamily">
                                <option value="'Noto Serif SC', serif">思源宋体</option>
                                <option value="'Times New Roman', serif">Times New Roman</option>
                                <option value="'Playfair Display', serif">古典衬线体</option>
                                <option value="'Roboto', sans-serif">现代无衬线体</option>
                                <option value="'Courier New', monospace">打字机体</option>
                            </select>
                            <div id="paperDateFontPreview" class="font-preview">期号字体预览</div>
                        </div>
                        <div class="control-item">
                            <label for="paperDateColor">期号颜色</label>
                            <div class="color-picker-container">
                                <input type="color" id="paperDateColor" class="color-picker" value="#666666">
                                <span id="paperDateColorValue" class="color-value">#666666</span>
                            </div>
                            <div id="paperDateColorPreview" class="color-preview" style="background-color: #666666;"></div>
                        </div>
                    </div>
                </div>
                <div class="control-group control-group-title">
                    <div class="control-group-header-content">
                        <h3><i class="fas fa-heading"></i> 标题样式设置</h3>
                    </div>
                    <div class="control-row">
                        <div class="control-item">
                            <label for="articleTitle">文章标题</label>
                            <input type="text" id="articleTitle" placeholder="请输入文章标题..." value="这里是文章标题">
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-item">
                            <label for="titleFontSize">标题字号：<span id="titleSizeValue" class="size-value">48</span>px</label>
                            <div class="font-size-control">
                                <input type="range" id="titleFontSize" min="24" max="72" value="48">
                            </div>
                        </div>
                        <div class="control-item">
                            <label for="titleFontFamily">标题字体</label>
                            <select id="titleFontFamily">
                                <option value="'Playfair Display', serif">古典衬线体</option>
                                <option value="'Noto Serif SC', serif">思源宋体</option>
                                <option value="'Roboto', sans-serif">现代无衬线体</option>
                                <option value="'Source Code Pro', monospace">等宽字体</option>
                                <option value="'Comic Neue', cursive">手写体</option>
                            </select>
                            <div id="titleFontPreview" class="font-preview">标题字体预览</div>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-item">
                            <label for="titleColor">标题颜色</label>
                            <div class="color-picker-container">
                                <input type="color" id="titleColor" class="color-picker" value="#222222">
                                <span id="titleColorValue" class="color-value">#222222</span>
                            </div>
                            <div id="titleColorPreview" class="color-preview" style="background-color: #222222;"></div>
                        </div>
                        <div class="control-item">
                            <label for="titleAlign">标题对齐</label>
                            <select id="titleAlign">
                                <option value="center">居中</option>
                                <option value="left">左对齐</option>
                                <option value="right">右对齐</option>
                                <option value="justify">两端对齐</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="control-group control-group-text">
                    <div class="control-group-header-content">
                        <h3><i class="fas fa-paragraph"></i> 正文样式设置</h3>
                    </div>
                    <div class="control-row">
                        <div class="control-item">
                            <label for="articleContent">文章内容</label>
                            <textarea id="articleContent" placeholder="请输入文章内容...">总之这里就是正文了！
电脑上的预览是横屏输出的，输出也可以多栏式的排版，手机上似乎是默认竖着。

段落小标题示例
这是一个段落小标题的示例，可以在富文本编辑器中添加。

[图片]

在段落之间插入图片示例
这是图片上方的文字。

[图片]

这是图片下方的文字。</textarea>
                            <!-- 富文本编辑按钮 -->
                            <button id="toggleRichTextBtn" class="rich-text-toggle-btn">
                                <i class="fas fa-edit"></i> 打开富文本编辑器
                            </button>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-item">
                            <label for="contentFontSize">正文字号：<span id="contentSizeValue" class="size-value">16</span>px</label>
                            <div class="font-size-control">
                                <input type="range" id="contentFontSize" min="12" max="24" value="16">
                            </div>
                        </div>
                        <div class="control-item">
                            <label for="contentFontFamily">正文字体</label>
                            <select id="contentFontFamily">
                                <option value="'Noto Serif SC', serif">思源宋体</option>
                                <option value="'Playfair Display', serif">古典衬线体</option>
                                <option value="'Roboto', sans-serif">现代无衬线体</option>
                                <option value="'Source Code Pro', monospace">等宽字体</option>
                            </select>
                            <div id="contentFontPreview" class="font-preview">正文字体预览</div>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-item">
                            <label for="contentColor">正文颜色</label>
                            <div class="color-picker-container">
                                <input type="color" id="contentColor" class="color-picker" value="#333333">
                                <span id="contentColorValue" class="color-value">#333333</span>
                            </div>
                            <div id="contentColorPreview" class="color-preview" style="background-color: #333333;"></div>
                        </div>
                        <div class="control-item">
                            <label for="lineHeight">行高</label>
                            <div class="font-size-control">
                                <input type="range" id="lineHeight" min="1.2" max="2.0" step="0.1" value="1.6">
                                <span id="lineHeightValue" class="size-value">1.6</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 多栏布局控制 -->
                    <div class="control-row">
                        <div class="control-item">
                            <label for="columnCount">分栏数量：<span id="columnCountValue" class="size-value">2</span>栏</label>
                            <div class="font-size-control">
                                <input type="range" id="columnCount" min="1" max="4" value="2">
                            </div>
                            <div class="control-subtitle" style="margin-top: 5px;">电脑端有效，手机端始终为单栏</div>
                        </div>
                        <div class="control-item">
                            <label for="columnGap">栏间距：<span id="columnGapValue" class="size-value">30</span>px</label>
                            <div class="font-size-control">
                                <input type="range" id="columnGap" min="10" max="60" value="30">
                            </div>
                        </div>
                    </div>
                </div>
                <div class="control-group control-group-footer">
                    <div class="control-group-header-content">
                        <h3><i class="fas fa-info-circle"></i> 底部信息设置</h3>
                        <div>
                            <span style="margin-right: 10px; font-size: 0.9rem;">显示底部信息</span>
                            <label class="toggle-switch">
                                <input type="checkbox" id="footerVisible" checked>
                                <span class="toggle-slider"></span>
                            </label>
                        </div>
                    </div>
                    <div class="control-subtitle">控制是否显示报纸底部的生成信息</div>
                    <div class="control-row">
                        <div class="control-item">
                            <label for="footerText">自定义底部信息</label>
                            <input type="text" id="footerText" placeholder="请输入自定义底部信息..." value="本报纸由「XX日报生成器」创建于">
                        </div>
                    </div>
                    <!-- 是否添加日期复选框 -->
                    <div class="control-row">
                        <div class="control-item">
                            <label for="showFooterDate" style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="showFooterDate" checked>
                                <span>在底部信息后添加生成日期</span>
                            </label>
                        </div>
                    </div>
                    <div class="control-row">
                        <div class="control-item">
                            <label for="footerFontSize">底部信息字号：<span id="footerSizeValue" class="size-value">14</span>px</label>
                            <div class="font-size-control">
                                <input type="range" id="footerFontSize" min="10" max="24" value="14">
                            </div>
                        </div>
                        <div class="control-item">
                            <label for="footerColor">底部信息颜色</label>
                            <div class="color-picker-container">
                                <input type="color" id="footerColor" class="color-picker" value="#666666">
                                <span id="footerColorValue" class="color-value">#666666</span>
                            </div>
                            <div id="footerColorPreview" class="color-preview" style="background-color: #666666;"></div>
                        </div>
                    </div>
                </div>
                <!-- 保存和加载按钮 -->
                <div class="buttons">
                    <button class="generate-btn" id="generateBtn">
                        <i class="fas fa-magic"></i> 生成报纸
                    </button>
                    <button class="download-btn" id="downloadBtn">
                        <i class="fas fa-download"></i> 下载图片
                    </button>
                    <button class="save-btn" id="saveBtn">
                        <i class="fas fa-save"></i> 储存内容
                    </button>
                    <button class="load-btn" id="loadBtn">
                        <i class="fas fa-folder-open"></i> 加载内容
                    </button>
                    <button class="reset-btn" id="resetBtn">
                        <i class="fas fa-redo"></i> 重置
                    </button>
                </div>
            </div>
            <div class="newspaper-preview">
                <h2 class="section-title"><i class="fas fa-eye"></i> 报纸预览（实时更新）</h2>
                <div class="newspaper" id="newspaper">
                    <div class="newspaper-content">
                        <div class="newspaper-header" id="newspaperHeader">
                            <h1 class="paper-name" id="previewPaperName">XX日报</h1>
                            <p class="paper-date" id="previewPaperDate">第XXXX期 · XXXX专刊 · XXXX年XX月XX日（这里依然也是可以碎碎念，写'作者xxx'也可以，什么都行）</p>
                        </div>
                        <h2 class="article-title" id="previewTitle">这里是文章标题</h2>
                        <div class="article-content" id="articleContentDiv">
                            <div class="article-image-container" id="articleImageContainer">
                                <img id="previewImage" class="article-image" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiPjxyZWN0IHdpZHRoPSI2MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iMzAwIiB5PSIyMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzgwODA4MCI+UElDVFVSRSBQTEFDRUhPTERFUjwvdGV4dD48L3N2Zz4=" alt="报纸插图">
                                <p id="previewCaption" class="article-image-caption">上面可以插入图片，这里可以输入图片备注（当然吐槽碎碎念也没问题。</p>
                            </div>
                            <div class="article-text" id="previewContent">
                                <p>总之这里就是正文了！</p>
                                <p>电脑上的预览是横屏输出的，输出也可以多栏式的排版，手机上似乎是默认竖着。</p>
                                <h3>段落小标题示例</h3>
                                <p>这是一个段落小标题的示例，可以在富文本编辑器中添加。</p>
                                <div class="inline-image">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiPjxyZWN0IHdpZHRoPSI2MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iMzAwIiB5PSIyMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzgwODA4MCI+QVJUSUNMRSBJTUFHRTwvdGV4dD48L3N2Zz4=" alt="文章插图">
                                </div>
                                <h3>在段落之间插入图片示例</h3>
                                <p>这是图片上方的文字。</p>
                                <div class="inline-image">
                                    <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiPjxyZWN0IHdpZHRoPSI2MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iMzAwIiB5PSIyMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzgwODA4MCI+QVJUSUNMRSBJTUFHRTwvdGV4dD48L3N2Zz4=" alt="文章插图">
                                </div>
                                <p>这是图片下方的文字。</p>
                            </div>
                        </div>
                        <div class="newspaper-footer" id="newspaperFooter">
                            <p class="generated-date" id="previewFooterText">本报纸由「XX日报生成器」创建于 <span id="generationDate">2026年1月25日</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 富文本编辑器模态框 -->
        <div class="modal-overlay" id="richTextModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3><i class="fas fa-edit"></i> 富文本编辑 - 文章内容</h3>
                    <button class="modal-btn modal-btn-secondary" id="closeRichTextBtn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <div class="rich-text-controls">
                        <button class="rich-text-btn" data-command="bold" title="加粗" id="boldBtn">
                            <i class="fas fa-bold"></i>
                        </button>
                        <button class="rich-text-btn" data-command="italic" title="斜体" id="italicBtn">
                            <i class="fas fa-italic"></i>
                        </button>
                        <button class="rich-text-btn" data-command="underline" title="下划线" id="underlineBtn">
                            <i class="fas fa-underline"></i>
                        </button>
                        <button class="rich-text-btn" data-command="insertUnorderedList" title="无序列表" id="unorderedListBtn">
                            <i class="fas fa-list-ul"></i>
                        </button>
                        <button class="rich-text-btn" data-command="insertOrderedList" title="有序列表" id="orderedListBtn">
                            <i class="fas fa-list-ol"></i>
                        </button>
                        <button class="rich-text-btn" data-command="formatBlock" data-value="h3" title="段落小标题" id="headingBtn">
                            <i class="fas fa-heading"></i> 小标题
                        </button>
                        <button class="rich-text-btn" data-command="formatBlock" data-value="p" title="普通段落" id="paragraphBtn">
                            <i class="fas fa-paragraph"></i> 段落
                        </button>
                        <button class="rich-text-btn" id="insertImageBtn" title="插入图片">
                            <i class="fas fa-image"></i> 插入图片
                        </button>
                        <button class="rich-text-btn" id="uploadMoreImagesBtn" title="上传更多图片">
                            <i class="fas fa-upload"></i> 上传图片
                        </button>
                    </div>
                    
                    <div class="rich-text-editor" id="richTextEditor" contenteditable="true"></div>
                    
                    <div class="image-upload-area" id="richTextImageUpload" style="display: none;">
                        <i class="fas fa-cloud-upload-alt"></i>
                        <p>点击此处上传图片，或拖放图片文件</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">支持多张图片上传</p>
                        <input type="file" id="richTextImageInput" accept="image/*" multiple style="display: none;">
                    </div>
                    
                    <div class="image-preview-container" id="richTextImagePreview"></div>
                    <p class="current-image-count" id="imageCount">已上传图片: 0 张</p>
                </div>
                
                <div class="modal-footer">
                    <button class="modal-btn modal-btn-secondary" id="cancelRichTextBtn">
                        取消
                    </button>
                    <button class="modal-btn modal-btn-primary" id="saveRichTextBtn">
                        保存并应用
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 错误弹窗 -->
        <div class="error-modal" id="errorModal">
            <div class="error-content">
                <div class="error-header">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>图片生成错误</h3>
                </div>
                <p>抱歉，生成图片时遇到了问题。以下是可能的错误原因和解决方案：</p>
                <div class="error-details" id="errorDetails">
                    <!-- 错误详情将动态填充到这里 -->
                </div>
                <div class="error-solution">
                    <h4>可能的解决方案：</h4>
                    <ul id="errorSolution">
                        <!-- 解决方案将动态填充到这里 -->
                    </ul>
                </div>
                <div class="error-buttons">
                    <button class="error-btn error-btn-secondary" id="closeErrorBtn">关闭</button>
                    <button class="error-btn error-btn-primary" id="retryBtn">重试</button>
                </div>
            </div>
        </div>
        
        <div class="toast" id="toast">报纸已更新！</div>
        <footer>
            <p>工具制作：@村里最乱炒的坏厨</p>
            <p>提示：所有设置更改会自动实时预览，点击"下载图片"将保存为PNG格式</p>
        </footer>
    </div>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script>
        // 获取DOM元素
        const imageInput = document.getElementById('imageInput');
        const imageUpload = document.getElementById('imageUpload');
        const imagePreview = document.getElementById('imagePreview');
        const imageCaption = document.getElementById('imageCaption');
        const imageVisible = document.getElementById('imageVisible');
        
        // 报纸头部控件
        const headerVisible = document.getElementById('headerVisible');
        const paperName = document.getElementById('paperName');
        const paperNameFontSize = document.getElementById('paperNameFontSize');
        const paperNameFontFamily = document.getElementById('paperNameFontFamily');
        const paperNameColor = document.getElementById('paperNameColor');
        const paperNameSizeValue = document.getElementById('paperNameSizeValue');
        const paperNameColorValue = document.getElementById('paperNameColorValue');
        const paperNameColorPreview = document.getElementById('paperNameColorPreview');
        const paperNameFontPreview = document.getElementById('paperNameFontPreview');
        const paperDateText = document.getElementById('paperDateText');
        const paperDateFontSize = document.getElementById('paperDateFontSize');
        const paperDateFontFamily = document.getElementById('paperDateFontFamily');
        const paperDateColor = document.getElementById('paperDateColor');
        const paperDateSizeValue = document.getElementById('paperDateSizeValue');
        const paperDateColorValue = document.getElementById('paperDateColorValue');
        const paperDateColorPreview = document.getElementById('paperDateColorPreview');
        const paperDateFontPreview = document.getElementById('paperDateFontPreview');
        
        // 标题控件
        const articleTitle = document.getElementById('articleTitle');
        const titleFontSize = document.getElementById('titleFontSize');
        const titleFontFamily = document.getElementById('titleFontFamily');
        const titleColor = document.getElementById('titleColor');
        const titleAlign = document.getElementById('titleAlign');
        const titleSizeValue = document.getElementById('titleSizeValue');
        const titleColorValue = document.getElementById('titleColorValue');
        const titleColorPreview = document.getElementById('titleColorPreview');
        const titleFontPreview = document.getElementById('titleFontPreview');
        
        // 正文控件
        const articleContent = document.getElementById('articleContent');
        const contentFontSize = document.getElementById('contentFontSize');
        const contentFontFamily = document.getElementById('contentFontFamily');
        const contentColor = document.getElementById('contentColor');
        const lineHeight = document.getElementById('lineHeight');
        const contentSizeValue = document.getElementById('contentSizeValue');
        const contentColorValue = document.getElementById('contentColorValue');
        const contentColorPreview = document.getElementById('contentColorPreview');
        const contentFontPreview = document.getElementById('contentFontPreview');
        const lineHeightValue = document.getElementById('lineHeightValue');
        
        // 底部信息控件
        const footerVisible = document.getElementById('footerVisible');
        const footerText = document.getElementById('footerText');
        const footerFontSize = document.getElementById('footerFontSize');
        const footerColor = document.getElementById('footerColor');
        const footerSizeValue = document.getElementById('footerSizeValue');
        const footerColorValue = document.getElementById('footerColorValue');
        const footerColorPreview = document.getElementById('footerColorPreview');
        
        // 新增：底部日期显示/隐藏控件
        const showFooterDate = document.getElementById('showFooterDate');
        
        // 按钮和预览
        const generateBtn = document.getElementById('generateBtn');
        const downloadBtn = document.getElementById('downloadBtn');
        const saveBtn = document.getElementById('saveBtn'); // 新增
        const loadBtn = document.getElementById('loadBtn'); // 新增
        const resetBtn = document.getElementById('resetBtn');
        const newspaperHeader = document.getElementById('newspaperHeader');
        const previewPaperName = document.getElementById('previewPaperName');
        const previewPaperDate = document.getElementById('previewPaperDate');
        const previewTitle = document.getElementById('previewTitle');
        const articleImageContainer = document.getElementById('articleImageContainer');
        const previewImage = document.getElementById('previewImage');
        const previewCaption = document.getElementById('previewCaption');
        const previewContent = document.getElementById('previewContent');
        const newspaperFooter = document.getElementById('newspaperFooter');
        const previewFooterText = document.getElementById('previewFooterText');
        const generationDate = document.getElementById('generationDate');
        const toast = document.getElementById('toast');
        
        // 新增：布局切换控件
        const horizontalLayoutBtn = document.getElementById('horizontalLayoutBtn');
        const verticalLayoutBtn = document.getElementById('verticalLayoutBtn');
        const mainContent = document.querySelector('.main-content');
        const container = document.querySelector('.container');
        
        // 新增：错误弹窗控件
        const errorModal = document.getElementById('errorModal');
        const errorDetails = document.getElementById('errorDetails');
        const errorSolution = document.getElementById('errorSolution');
        const closeErrorBtn = document.getElementById('closeErrorBtn');
        const retryBtn = document.getElementById('retryBtn');
        
        // 新增：富文本编辑器相关变量
        const richTextModal = document.getElementById('richTextModal');
        const richTextEditor = document.getElementById('richTextEditor');
        const toggleRichTextBtn = document.getElementById('toggleRichTextBtn');
        const closeRichTextBtn = document.getElementById('closeRichTextBtn');
        const cancelRichTextBtn = document.getElementById('cancelRichTextBtn');
        const saveRichTextBtn = document.getElementById('saveRichTextBtn');
        const insertImageBtn = document.getElementById('insertImageBtn');
        const uploadMoreImagesBtn = document.getElementById('uploadMoreImagesBtn');
        const richTextImageUpload = document.getElementById('richTextImageUpload');
        const richTextImageInput = document.getElementById('richTextImageInput');
        const richTextImagePreview = document.getElementById('richTextImagePreview');
        const imageCount = document.getElementById('imageCount');
        
        // 新增：富文本工具栏按钮
        const boldBtn = document.getElementById('boldBtn');
        const italicBtn = document.getElementById('italicBtn');
        const underlineBtn = document.getElementById('underlineBtn');
        const unorderedListBtn = document.getElementById('unorderedListBtn');
        const orderedListBtn = document.getElementById('orderedListBtn');
        const headingBtn = document.getElementById('headingBtn');
        const paragraphBtn = document.getElementById('paragraphBtn');
        
        // 新增：从第二个文件添加的功能控件
        const paperNoise = document.getElementById('paperNoise');
        const imageLayout = document.getElementById('imageLayout');
        const articleContentDiv = document.getElementById('articleContentDiv');
        const forceDesktopExport = document.getElementById('forceDesktopExport');
        const forceMobileExport = document.getElementById('forceMobileExport'); // 新增
        const paperDateVisible = document.getElementById('paperDateVisible');
        
        // 新增：多栏布局控制变量
        const columnCount = document.getElementById('columnCount');
        const columnCountValue = document.getElementById('columnCountValue');
        const columnGap = document.getElementById('columnGap');
        const columnGapValue = document.getElementById('columnGapValue');
        
        // 新增：富文本图片存储
        let uploadedImages = [];
        let isRichTextMode = false;
        
        // 新增：保存富文本HTML内容
        let articleContentHTML = '';
        
        // 新增：背景颜色自定义控件
        const backgroundColor = document.getElementById('backgroundColor');
        const backgroundColorValue = document.getElementById('backgroundColorValue');
        const backgroundColorPreview = document.getElementById('backgroundColorPreview');
        const borderColor = document.getElementById('borderColor');
        const borderColorValue = document.getElementById('borderColorValue');
        const borderColorPreview = document.getElementById('borderColorPreview');
        const resetBackgroundBtn = document.getElementById('resetBackgroundBtn');
        
        // 初始化字体预览
        updateFontPreview(paperNameFontPreview, paperNameFontFamily.value);
        updateFontPreview(paperDateFontPreview, paperDateFontFamily.value);
        updateFontPreview(titleFontPreview, titleFontFamily.value);
        updateFontPreview(contentFontPreview, contentFontFamily.value);
        
        // 设置生成日期
        const now = new Date();
        const formattedDate = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日`;
        generationDate.textContent = formattedDate;
        
        // 页面加载时检查是否有保存的内容
        window.addEventListener('DOMContentLoaded', () => {
            // 检查是否有保存的数据
            if (localStorage.getItem('newspaperSettings') && confirm('检测到上次保存的报纸设置，是否恢复？')) {
                loadSettings();
            }
            
            // 更新颜色预览
            paperNameColorPreview.style.backgroundColor = paperNameColor.value;
            paperDateColorPreview.style.backgroundColor = paperDateColor.value;
            titleColorPreview.style.backgroundColor = titleColor.value;
            contentColorPreview.style.backgroundColor = contentColor.value;
            footerColorPreview.style.backgroundColor = footerColor.value;
            backgroundColorPreview.style.backgroundColor = backgroundColor.value;
            borderColorPreview.style.backgroundColor = borderColor.value;
            
            // 应用所有样式并初始化报纸
            applyAllStyles();
            updateNewspaper();
            
            // 初始化富文本编辑器内容
            updatePreviewFromText();
            
            // 初始化图片布局
            articleContentDiv.classList.add(`layout-${imageLayout.value}`);
            
            // 为富文本编辑器添加事件监听以更新按钮状态
            setupRichTextEditorEvents();
            
            // 新增：电脑版和手机版导出选项互斥
            forceDesktopExport.addEventListener('change', function() {
                if (this.checked) {
                    forceMobileExport.checked = false;
                }
            });
            
            forceMobileExport.addEventListener('change', function() {
                if (this.checked) {
                    forceDesktopExport.checked = false;
                }
            });
            
            // 新增：初始化多栏布局控制
            updateColumnLayout();
        });
        
        // 新增：更新多栏布局
        function updateColumnLayout() {
            columnCountValue.textContent = columnCount.value;
            columnGapValue.textContent = columnGap.value;
            
            // 更新预览中的栏数
            const articleText = document.querySelector('.article-text');
            if (articleText) {
                articleText.style.columnCount = columnCount.value;
                articleText.style.columnGap = `${columnGap.value}px`;
            }
            
            updateNewspaper();
        }
        
        // 新增：设置富文本编辑器事件
        function setupRichTextEditorEvents() {
            // 监听选择变化
            richTextEditor.addEventListener('mouseup', updateRichTextButtonStates);
            richTextEditor.addEventListener('keyup', updateRichTextButtonStates);
            richTextEditor.addEventListener('click', updateRichTextButtonStates);
            
            // 监听编辑器内容变化
            richTextEditor.addEventListener('input', function() {
                updateRichTextButtonStates();
            });
        }
        
        // 新增：更新富文本编辑器按钮状态
        function updateRichTextButtonStates() {
            // 检查当前选区状态
            if (document.queryCommandState) {
                boldBtn.classList.toggle('active', document.queryCommandState('bold'));
                italicBtn.classList.toggle('active', document.queryCommandState('italic'));
                underlineBtn.classList.toggle('active', document.queryCommandState('underline'));
                
                // 检查是否为列表
                const isUnorderedList = document.queryCommandState('insertUnorderedList');
                const isOrderedList = document.queryCommandState('insertOrderedList');
                unorderedListBtn.classList.toggle('active', isUnorderedList);
                orderedListBtn.classList.toggle('active', isOrderedList);
                
                // 检查当前块级元素
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const parentElement = range.commonAncestorContainer;
                    
                    // 向上查找块级元素
                    let blockElement = parentElement;
                    while (blockElement && blockElement.nodeType !== 1) {
                        blockElement = blockElement.parentElement;
                    }
                    
                    if (blockElement) {
                        // 检查是否为标题
                        const isHeading = blockElement.tagName === 'H3' || 
                                        (blockElement.parentElement && blockElement.parentElement.tagName === 'H3');
                        headingBtn.classList.toggle('active', isHeading);
                        
                        // 检查是否为段落
                        const isParagraph = blockElement.tagName === 'P' || 
                                          (blockElement.parentElement && blockElement.parentElement.tagName === 'P');
                        paragraphBtn.classList.toggle('active', isParagraph);
                    }
                }
            }
        }
        
        // 新增：噪点开关事件
        paperNoise.addEventListener('change', function() {
            const paper = document.getElementById('newspaper');
            if (this.checked) paper.classList.add('has-noise');
            else paper.classList.remove('has-noise');
            updateNewspaper();
        });
        
        // 新增：图片布局切换事件
        imageLayout.addEventListener('change', function() {
            articleContentDiv.classList.remove('layout-column', 'layout-row', 'layout-row-reverse');
            articleContentDiv.classList.add(`layout-${this.value}`);
            updateNewspaper();
        });
        
        // 新增：期号显示/隐藏事件
        paperDateVisible.addEventListener('change', function() {
            previewPaperDate.style.display = this.checked ? 'block' : 'none';
            updateNewspaper();
        });
        
        // 新增：背景颜色自定义事件
        backgroundColor.addEventListener('input', function() {
            backgroundColorValue.textContent = this.value;
            backgroundColorPreview.style.backgroundColor = this.value;
            
            // 更新报纸背景颜色
            const newspaper = document.getElementById('newspaper');
            newspaper.style.backgroundColor = this.value;
            updateNewspaper();
        });
        
        // 新增：边框颜色自定义事件
        borderColor.addEventListener('input', function() {
            borderColorValue.textContent = this.value;
            borderColorPreview.style.backgroundColor = this.value;
            
            // 更新报纸边框颜色
            const newspaper = document.getElementById('newspaper');
            newspaper.style.borderColor = this.value;
            updateNewspaper();
        });
        
        // 新增：重置背景颜色按钮事件
        resetBackgroundBtn.addEventListener('click', function() {
            backgroundColor.value = '#faf8f2';
            backgroundColor.dispatchEvent(new Event('input'));
            
            borderColor.value = '#d4c9b8';
            borderColor.dispatchEvent(new Event('input'));
            
            showToast('背景颜色已重置为默认值！');
        });
        
        // 新增：多栏布局控制事件
        columnCount.addEventListener('input', function() {
            updateColumnLayout();
        });
        
        columnGap.addEventListener('input', function() {
            updateColumnLayout();
        });
        
        // 新增：富文本编辑按钮点击事件
        toggleRichTextBtn.addEventListener('click', function() {
            openRichTextEditor();
        });
        
        // 新增：打开富文本编辑器
        function openRichTextEditor() {
            isRichTextMode = true;
            
            // 保存当前文本内容到富文本编辑器
            const plainText = articleContent.value;
            if (plainText) {
                // 如果有保存的富文本HTML，使用它
                if (articleContentHTML) {
                    richTextEditor.innerHTML = articleContentHTML;
                } else {
                    // 否则将纯文本转换为富文本格式
                    const paragraphs = plainText.split('\n').filter(p => p.trim() !== '');
                    let richText = '';
                    
                    paragraphs.forEach(paragraph => {
                        // 检查是否为标题（简单的启发式规则）
                        if (paragraph.length < 50 && !paragraph.includes('。') && !paragraph.includes('，') && !paragraph.includes('[') && !paragraph.includes(']')) {
                            richText += `<h3>${paragraph}</h3>`;
                        } else if (paragraph === '[图片]') {
                            // 图片占位符
                            richText += `<div class="inline-image"><img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiPjxyZWN0IHdpZHRoPSI2MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iMzAwIiB5PSIyMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzgwODA4MCI+QVJUSUNMRSBJTUFHRTwvdGV4dD48L3N2Zz4=" alt="文章插图"></div>`;
                        } else {
                            richText += `<p>${paragraph}</p>`;
                        }
                    });
                    
                    richTextEditor.innerHTML = richText;
                }
            } else {
                richTextEditor.innerHTML = '<p>在此处编辑文章内容...</p>';
            }
            
            // 显示模态框
            richTextModal.style.display = 'flex';
            
            // 重置图片预览
            uploadedImages = [];
            updateImagePreview();
            
            // 聚焦到编辑器
            setTimeout(() => {
                richTextEditor.focus();
                updateRichTextButtonStates();
            }, 100);
        }
        
        // 新增：富文本工具栏按钮事件
        document.querySelectorAll('.rich-text-btn[data-command]').forEach(button => {
            button.addEventListener('click', function() {
                const command = this.getAttribute('data-command');
                const value = this.getAttribute('data-value');
                
                // 执行命令
                document.execCommand(command, false, value);
                
                // 重新聚焦编辑器
                richTextEditor.focus();
                
                // 更新按钮状态
                updateRichTextButtonStates();
            });
        });
        
        // 新增：插入图片按钮事件
        insertImageBtn.addEventListener('click', function() {
            if (uploadedImages.length === 0) {
                showToast('请先上传图片！');
                richTextImageUpload.style.display = 'block';
                return;
            }
            
            // 创建图片选择菜单
            const imageMenu = document.createElement('div');
            imageMenu.style.position = 'absolute';
            imageMenu.style.backgroundColor = 'white';
            imageMenu.style.border = '1px solid #d4c9b8';
            imageMenu.style.borderRadius = '4px';
            imageMenu.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            imageMenu.style.padding = '10px';
            imageMenu.style.zIndex = '1000';
            
            uploadedImages.forEach((imageData, index) => {
                const imgItem = document.createElement('div');
                imgItem.style.display = 'flex';
                imgItem.style.alignItems = 'center';
                imgItem.style.padding = '5px';
                imgItem.style.cursor = 'pointer';
                imgItem.style.borderBottom = '1px solid #eee';
                
                const img = document.createElement('img');
                img.src = imageData;
                img.style.width = '50px';
                img.style.height = '50px';
                img.style.objectFit = 'cover';
                img.style.marginRight = '10px';
                
                const imgLabel = document.createElement('span');
                imgLabel.textContent = `图片 ${index + 1}`;
                
                imgItem.appendChild(img);
                imgItem.appendChild(imgLabel);
                
                imgItem.addEventListener('click', function() {
                    // 在当前光标位置插入图片
                    const imgTag = `<div class="inline-image"><img src="${imageData}" alt="文章插图" style="max-width:100%; height:auto; margin:10px auto; display:block;"></div>`;
                    document.execCommand('insertHTML', false, imgTag);
                    
                    // 移除菜单
                    document.body.removeChild(imageMenu);
                    
                    // 重新聚焦编辑器
                    richTextEditor.focus();
                    
                    // 更新按钮状态
                    updateRichTextButtonStates();
                });
                
                imageMenu.appendChild(imgItem);
            });
            
            // 定位菜单
            const rect = insertImageBtn.getBoundingClientRect();
            imageMenu.style.left = rect.left + 'px';
            imageMenu.style.top = (rect.bottom + 5) + 'px';
            
            document.body.appendChild(imageMenu);
            
            // 点击外部关闭菜单
            setTimeout(() => {
                const closeMenu = function(e) {
                    if (!imageMenu.contains(e.target) && e.target !== insertImageBtn) {
                        document.body.removeChild(imageMenu);
                        document.removeEventListener('click', closeMenu);
                    }
                };
                document.addEventListener('click', closeMenu);
            }, 0);
        });
        
        // 新增：上传更多图片按钮事件
        uploadMoreImagesBtn.addEventListener('click', function() {
            richTextImageUpload.style.display = 'block';
            richTextImageInput.click();
        });
        
        // 新增：富文本图片上传
        richTextImageUpload.addEventListener('click', () => {
            richTextImageInput.click();
        });
        
        richTextImageInput.addEventListener('change', function() {
            if (this.files && this.files.length > 0) {
                const files = Array.from(this.files);
                let loadedCount = 0;
                
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            uploadedImages.push(e.target.result);
                            loadedCount++;
                            
                            if (loadedCount === files.length) {
                                updateImagePreview();
                                showToast(`成功上传 ${files.length} 张图片！`);
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
                
                if (files.length === 0) {
                    showToast('请选择图片文件！');
                }
            }
        });
        
        // 新增：支持拖放上传
        richTextImageUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            richTextImageUpload.style.borderColor = '#8c2e2e';
        });
        
        richTextImageUpload.addEventListener('dragleave', () => {
            richTextImageUpload.style.borderColor = '#d4c9b8';
        });
        
        richTextImageUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            richTextImageUpload.style.borderColor = '#d4c9b8';
            
            if (e.dataTransfer.files.length) {
                richTextImageInput.files = e.dataTransfer.files;
                const files = Array.from(e.dataTransfer.files);
                let loadedCount = 0;
                
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            uploadedImages.push(e.target.result);
                            loadedCount++;
                            
                            if (loadedCount === files.length) {
                                updateImagePreview();
                                showToast(`成功上传 ${files.length} 张图片！`);
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }
        });
        
        // 新增：更新图片预览
        function updateImagePreview() {
            richTextImagePreview.innerHTML = '';
            
            uploadedImages.forEach((imageData, index) => {
                const previewItem = document.createElement('div');
                previewItem.className = 'image-preview-item';
                
                const img = document.createElement('img');
                img.src = imageData;
                img.alt = `图片 ${index + 1}`;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'remove-btn';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.title = '移除图片';
                
                removeBtn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    uploadedImages.splice(index, 1);
                    updateImagePreview();
                    showToast('图片已移除');
                });
                
                previewItem.appendChild(img);
                previewItem.appendChild(removeBtn);
                richTextImagePreview.appendChild(previewItem);
            });
            
            imageCount.textContent = `已上传图片: ${uploadedImages.length} 张`;
            
            // 如果没有图片，显示上传区域
            if (uploadedImages.length === 0) {
                richTextImageUpload.style.display = 'block';
            } else {
                richTextImageUpload.style.display = 'none';
            }
        }
        
        // 新增：关闭富文本编辑器
        closeRichTextBtn.addEventListener('click', closeRichTextModal);
        cancelRichTextBtn.addEventListener('click', closeRichTextModal);
        
        function closeRichTextModal() {
            richTextModal.style.display = 'none';
            isRichTextMode = false;
        }
        
        // 新增：保存富文本内容
        saveRichTextBtn.addEventListener('click', function() {
            // 获取富文本编辑器内容
            articleContentHTML = richTextEditor.innerHTML;
            
            // 将富文本内容转换为纯文本（用于文本域）
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = articleContentHTML;
            
            // 提取所有文本内容
            let plainText = '';
            
            // 处理所有元素
            const elements = tempDiv.children;
            for (let i = 0; i < elements.length; i++) {
                const element = elements[i];
                
                if (element.tagName === 'H3') {
                    // 小标题
                    plainText += element.textContent + '\n\n';
                } else if (element.tagName === 'P') {
                    // 段落
                    plainText += element.textContent + '\n\n';
                } else if (element.classList && element.classList.contains('inline-image')) {
                    // 图片容器
                    plainText += '[图片]\n\n';
                } else if (element.tagName === 'UL' || element.tagName === 'OL') {
                    // 列表
                    const listItems = element.querySelectorAll('li');
                    listItems.forEach(item => {
                        plainText += '• ' + item.textContent + '\n';
                    });
                    plainText += '\n';
                } else {
                    // 其他元素
                    plainText += element.textContent + '\n\n';
                }
            }
            
            // 更新文本域内容
            articleContent.value = plainText.trim();
            
            // 更新预览
            updatePreviewFromRichText(articleContentHTML);
            
            // 关闭模态框
            closeRichTextModal();
            
            showToast('富文本内容已保存并应用！');
        });
        
        // 新增：从富文本更新预览
        function updatePreviewFromRichText(richTextContent) {
            // 清空现有预览内容
            previewContent.innerHTML = '';
            
            // 解析富文本内容并添加到预览
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = richTextContent;
            
            // 处理所有元素
            const elements = tempDiv.children;
            for (let i = 0; i < elements.length; i++) {
                const element = elements[i];
                
                if (element.tagName === 'H3') {
                    // 小标题
                    const h3 = document.createElement('h3');
                    h3.style.cssText = `
                        color: #8c2e2e;
                        margin: 20px 0 10px 0;
                        padding-bottom: 5px;
                        border-bottom: 1px solid #e0d6c2;
                        font-size: 1.3em;
                        font-weight: bold;
                    `;
                    h3.innerHTML = element.innerHTML; // 使用innerHTML以保留加粗、斜体等样式
                    previewContent.appendChild(h3);
                } else if (element.tagName === 'P') {
                    // 段落
                    const p = document.createElement('p');
                    p.innerHTML = element.innerHTML; // 使用innerHTML以保留加粗、斜体等样式
                    previewContent.appendChild(p);
                } else if (element.classList && element.classList.contains('inline-image')) {
                    // 图片容器
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'inline-image';
                    
                    const img = element.querySelector('img');
                    if (img) {
                        const newImg = document.createElement('img');
                        newImg.src = img.src;
                        newImg.alt = img.alt || '文章插图';
                        newImg.style.cssText = `
                            max-width: 100%;
                            height: auto;
                            border: 1px solid #d4c9b8;
                            padding: 5px;
                            background-color: white;
                            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
                        `;
                        imgContainer.appendChild(newImg);
                    }
                    previewContent.appendChild(imgContainer);
                } else if (element.tagName === 'UL') {
                    // 无序列表
                    const ul = document.createElement('ul');
                    ul.style.cssText = `
                        margin: 10px 0 10px 2em;
                        padding: 0;
                    `;
                    
                    const listItems = element.querySelectorAll('li');
                    listItems.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = item.innerHTML; // 使用innerHTML以保留加粗、斜体等样式
                        ul.appendChild(li);
                    });
                    
                    previewContent.appendChild(ul);
                } else if (element.tagName === 'OL') {
                    // 有序列表
                    const ol = document.createElement('ol');
                    ol.style.cssText = `
                        margin: 10px 0 10px 2em;
                        padding: 0;
                    `;
                    
                    const listItems = element.querySelectorAll('li');
                    listItems.forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = item.innerHTML; // 使用innerHTML以保留加粗、斜体等样式
                        ol.appendChild(li);
                    });
                    
                    previewContent.appendChild(ol);
                } else {
                    // 其他元素，直接复制
                    previewContent.appendChild(element.cloneNode(true));
                }
            }
            
            // 应用正文样式
            previewContent.style.fontSize = `${contentFontSize.value}px`;
            previewContent.style.fontFamily = contentFontFamily.value;
            previewContent.style.color = contentColor.value;
            previewContent.style.lineHeight = lineHeight.value;
            
            updateNewspaper();
        }
        
        // 新增：更新预览从纯文本
        function updatePreviewFromText() {
            const contentText = articleContent.value || "文章内容为空，请在上方编辑区域输入内容。";
            const paragraphs = contentText.split('\n').filter(p => p.trim() !== '');
            previewContent.innerHTML = '';
            
            paragraphs.forEach(paragraph => {
                // 检查是否为标题（简单的启发式规则）
                if (paragraph.length < 50 && !paragraph.includes('。') && !paragraph.includes('，') && !paragraph.includes('[') && !paragraph.includes(']')) {
                    const h3 = document.createElement('h3');
                    h3.style.cssText = `
                        color: #8c2e2e;
                        margin: 20px 0 10px 0;
                        padding-bottom: 5px;
                        border-bottom: 1px solid #e0d6c2;
                        font-size: 1.3em;
                        font-weight: bold;
                    `;
                    h3.textContent = paragraph;
                    previewContent.appendChild(h3);
                } else if (paragraph === '[图片]') {
                    // 图片占位符
                    const imgContainer = document.createElement('div');
                    imgContainer.className = 'inline-image';
                    
                    const img = document.createElement('img');
                    img.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiPjxyZWN0IHdpZHRoPSI2MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iMzAwIiB5PSIyMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzgwODA4MCI+QVJUSUNMRSBJTUFHRTwvdGV4dD48L3N2Zz4=";
                    img.alt = "文章插图";
                    img.style.cssText = `
                        max-width: 100%;
                        height: auto;
                        border: 1px solid #d4c9b8;
                        padding: 5px;
                        background-color: white;
                        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
                    `;
                    
                    imgContainer.appendChild(img);
                    previewContent.appendChild(imgContainer);
                } else {
                    const p = document.createElement('p');
                    p.textContent = paragraph;
                    previewContent.appendChild(p);
                }
            });
            
            // 应用正文样式
            previewContent.style.fontSize = `${contentFontSize.value}px`;
            previewContent.style.fontFamily = contentFontFamily.value;
            previewContent.style.color = contentColor.value;
            previewContent.style.lineHeight = lineHeight.value;
        }
        
        // 布局切换功能
        horizontalLayoutBtn.addEventListener('click', function() {
            container.classList.remove('vertical-layout');
            horizontalLayoutBtn.classList.add('active');
            verticalLayoutBtn.classList.remove('active');
            showToast('已切换为左右布局');
        });
        
        verticalLayoutBtn.addEventListener('click', function() {
            container.classList.add('vertical-layout');
            verticalLayoutBtn.classList.add('active');
            horizontalLayoutBtn.classList.remove('active');
            showToast('已切换为上下布局');
        });
        
        // 底部日期显示/隐藏控制
        showFooterDate.addEventListener('change', function() {
            updateFooterText();
        });
        
        // 图片显示/隐藏控制
        imageVisible.addEventListener('change', function() {
            if (this.checked) {
                articleImageContainer.style.display = 'block';
                previewContent.classList.remove('no-image');
            } else {
                articleImageContainer.style.display = 'none';
                previewContent.classList.add('no-image');
            }
            updateNewspaper();
        });
        
        // 图片上传功能
        imageUpload.addEventListener('click', () => {
            imageInput.click();
        });
        
        imageInput.addEventListener('change', function() {
            if (this.files && this.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    previewImage.src = e.target.result;
                    updateNewspaper();
                    showToast('图片上传成功！');
                };
                reader.readAsDataURL(this.files[0]);
            }
        });
        
        // 支持拖放上传
        imageUpload.addEventListener('dragover', (e) => {
            e.preventDefault();
            imageUpload.style.borderColor = '#8c2e2e';
        });
        
        imageUpload.addEventListener('dragleave', () => {
            imageUpload.style.borderColor = '#d4c9b8';
        });
        
        imageUpload.addEventListener('drop', (e) => {
            e.preventDefault();
            imageUpload.style.borderColor = '#d4c9b8';
            if (e.dataTransfer.files.length) {
                imageInput.files = e.dataTransfer.files;
                const reader = new FileReader();
                reader.onload = function(e) {
                    imagePreview.src = e.target.result;
                    imagePreview.style.display = 'block';
                    previewImage.src = e.target.result;
                    updateNewspaper();
                    showToast('图片上传成功！');
                };
                reader.readAsDataURL(e.dataTransfer.files[0]);
            }
        });
        
        // 报纸头部控制
        headerVisible.addEventListener('change', function() {
            newspaperHeader.style.display = this.checked ? 'block' : 'none';
            updateNewspaper();
        });
        
        paperNameFontSize.addEventListener('input', function() {
            paperNameSizeValue.textContent = this.value;
            previewPaperName.style.fontSize = `${this.value}px`;
            updateNewspaper();
        });
        
        paperNameFontFamily.addEventListener('change', function() {
            updateFontPreview(paperNameFontPreview, this.value);
            previewPaperName.style.fontFamily = this.value;
            updateNewspaper();
        });
        
        paperNameColor.addEventListener('input', function() {
            paperNameColorValue.textContent = this.value;
            paperNameColorPreview.style.backgroundColor = this.value;
            previewPaperName.style.color = this.value;
            updateNewspaper();
        });
        
        paperDateFontSize.addEventListener('input', function() {
            paperDateSizeValue.textContent = this.value;
            previewPaperDate.style.fontSize = `${this.value}px`;
            updateNewspaper();
        });
        
        paperDateFontFamily.addEventListener('change', function() {
            updateFontPreview(paperDateFontPreview, this.value);
            previewPaperDate.style.fontFamily = this.value;
            updateNewspaper();
        });
        
        paperDateColor.addEventListener('input', function() {
            paperDateColorValue.textContent = this.value;
            paperDateColorPreview.style.backgroundColor = this.value;
            previewPaperDate.style.color = this.value;
            updateNewspaper();
        });
        
        // 标题样式控制
        titleFontSize.addEventListener('input', function() {
            titleSizeValue.textContent = this.value;
            previewTitle.style.fontSize = `${this.value}px`;
            updateNewspaper();
        });
        
        titleFontFamily.addEventListener('change', function() {
            updateFontPreview(titleFontPreview, this.value);
            previewTitle.style.fontFamily = this.value;
            updateNewspaper();
        });
        
        titleColor.addEventListener('input', function() {
            titleColorValue.textContent = this.value;
            titleColorPreview.style.backgroundColor = this.value;
            previewTitle.style.color = this.value;
            updateNewspaper();
        });
        
        titleAlign.addEventListener('change', function() {
            previewTitle.style.textAlign = this.value;
            updateNewspaper();
        });
        
        // 正文样式控制
        contentFontSize.addEventListener('input', function() {
            contentSizeValue.textContent = this.value;
            previewContent.style.fontSize = `${this.value}px`;
            updateNewspaper();
        });
        
        contentFontFamily.addEventListener('change', function() {
            updateFontPreview(contentFontPreview, this.value);
            previewContent.style.fontFamily = this.value;
            updateNewspaper();
        });
        
        contentColor.addEventListener('input', function() {
            contentColorValue.textContent = this.value;
            contentColorPreview.style.backgroundColor = this.value;
            previewContent.style.color = this.value;
            updateNewspaper();
        });
        
        lineHeight.addEventListener('input', function() {
            lineHeightValue.textContent = this.value;
            previewContent.style.lineHeight = this.value;
            updateNewspaper();
        });
        
        // 文本内容实时更新
        articleContent.addEventListener('input', function() {
            // 当纯文本内容变化时，清空保存的富文本HTML
            articleContentHTML = '';
            updatePreviewFromText();
            updateNewspaper();
        });
        
        // 底部信息控制
        footerVisible.addEventListener('change', function() {
            newspaperFooter.style.display = this.checked ? 'block' : 'none';
            updateNewspaper();
        });
        
        footerFontSize.addEventListener('input', function() {
            footerSizeValue.textContent = this.value;
            previewFooterText.style.fontSize = `${this.value}px`;
            updateNewspaper();
        });
        
        footerColor.addEventListener('input', function() {
            footerColorValue.textContent = this.value;
            footerColorPreview.style.backgroundColor = this.value;
            previewFooterText.style.color = this.value;
            updateNewspaper();
        });
        
        footerText.addEventListener('input', function() {
            updateFooterText();
        });
        
        // 更新底部文本的函数
        function updateFooterText() {
            const footerContent = footerText.value ? footerText.value : "本报纸由「XX日报生成器」创建于";
            if (showFooterDate.checked) {
                previewFooterText.innerHTML = `${footerContent} <span id="generationDate">${generationDate.textContent}</span>`;
            } else {
                previewFooterText.innerHTML = footerContent;
            }
            updateNewspaper();
        }
        
        // 文本内容实时更新
        paperName.addEventListener('input', function() {
            previewPaperName.textContent = this.value || "报纸名称";
            updateNewspaper();
        });
        
        paperDateText.addEventListener('input', function() {
            previewPaperDate.textContent = this.value || "日期信息";
            updateNewspaper();
        });
        
        articleTitle.addEventListener('input', function() {
            previewTitle.textContent = this.value || "文章标题";
            updateNewspaper();
        });
        
        imageCaption.addEventListener('input', function() {
            previewCaption.textContent = this.value || "图片说明";
            updateNewspaper();
        });
        
        // 更新字体预览
        function updateFontPreview(previewElement, fontFamily) {
            previewElement.style.fontFamily = fontFamily;
            
            // 获取字体名称显示
            let fontName = "自定义字体";
            if (fontFamily.includes('Playfair Display')) fontName = "古典衬线体";
            else if (fontFamily.includes('Times New Roman')) fontName = "Times New Roman";
            else if (fontFamily.includes('Noto Serif SC')) fontName = "思源宋体";
            else if (fontFamily.includes('Roboto')) fontName = "现代无衬线体";
            else if (fontFamily.includes('Courier New')) fontName = "打字机体";
            else if (fontFamily.includes('Source Code Pro')) fontName = "等宽字体";
            else if (fontFamily.includes('Comic Neue')) fontName = "手写体";
            previewElement.textContent = fontName;
        }
        
        // 生成报纸预览
        generateBtn.addEventListener('click', function() {
            // 强制重新应用所有样式到预览
            applyAllStyles();
            updateNewspaper();
            showToast('报纸已重新生成！');
        });
        
        // 保存设置到本地存储
        saveBtn.addEventListener('click', function() {
            const settings = collectAllSettings();
            localStorage.setItem('newspaperSettings', JSON.stringify(settings));
            showToast('设置已保存到浏览器本地存储！');
        });
        
        // 从本地存储加载设置
        loadBtn.addEventListener('click', function() {
            if (confirm('确定要加载上次保存的设置吗？这将覆盖当前的设置。')) {
                loadSettings();
            }
        });
        
        // 收集所有设置
        function collectAllSettings() {
            const settings = {
                // 图片设置
                imageVisible: imageVisible.checked,
                imageCaption: imageCaption.value,
                // 如果有图片，保存图片的base64数据
                imageData: imagePreview.src.startsWith('data:image') ? imagePreview.src : null,
                
                // 新增：从第二个文件添加的功能设置
                paperNoise: paperNoise.checked,
                imageLayout: imageLayout.value,
                forceDesktopExport: forceDesktopExport.checked,
                forceMobileExport: forceMobileExport.checked, // 新增
                paperDateVisible: paperDateVisible.checked,
                
                // 新增：背景颜色设置
                backgroundColor: backgroundColor.value,
                borderColor: borderColor.value,
                
                // 新增：多栏布局设置
                columnCount: columnCount.value,
                columnGap: columnGap.value,
                
                // 报纸头部设置
                headerVisible: headerVisible.checked,
                paperName: paperName.value,
                paperNameFontSize: paperNameFontSize.value,
                paperNameFontFamily: paperNameFontFamily.value,
                paperNameColor: paperNameColor.value,
                paperDateText: paperDateText.value,
                paperDateFontSize: paperDateFontSize.value,
                paperDateFontFamily: paperDateFontFamily.value,
                paperDateColor: paperDateColor.value,
                
                // 标题样式设置
                articleTitle: articleTitle.value,
                titleFontSize: titleFontSize.value,
                titleFontFamily: titleFontFamily.value,
                titleColor: titleColor.value,
                titleAlign: titleAlign.value,
                
                // 正文样式设置
                articleContent: articleContent.value,
                contentFontSize: contentFontSize.value,
                contentFontFamily: contentFontFamily.value,
                contentColor: contentColor.value,
                lineHeight: lineHeight.value,
                
                // 富文本内容
                articleContentHTML: articleContentHTML,
                
                // 底部信息设置
                footerVisible: footerVisible.checked,
                footerText: footerText.value,
                footerFontSize: footerFontSize.value,
                footerColor: footerColor.value,
                showFooterDate: showFooterDate.checked,
                
                // 布局设置
                layout: container.classList.contains('vertical-layout') ? 'vertical' : 'horizontal',
                
                // 新增：富文本相关设置
                uploadedImages: uploadedImages,
                richTextContent: richTextEditor.innerHTML
            };
            return settings;
        }
        
        // 加载设置
        function loadSettings() {
            const savedSettings = localStorage.getItem('newspaperSettings');
            if (!savedSettings) {
                showToast('没有找到保存的设置！');
                return;
            }
            
            try {
                const settings = JSON.parse(savedSettings);
                
                // 图片设置
                imageVisible.checked = settings.imageVisible;
                imageCaption.value = settings.imageCaption;
                if (settings.imageData) {
                    imagePreview.src = settings.imageData;
                    imagePreview.style.display = 'block';
                    previewImage.src = settings.imageData;
                }
                articleImageContainer.style.display = settings.imageVisible ? 'block' : 'none';
                previewContent.classList.toggle('no-image', !settings.imageVisible);
                
                // 新增：加载从第二个文件添加的功能设置
                if (settings.paperNoise !== undefined) {
                    paperNoise.checked = settings.paperNoise;
                    paperNoise.dispatchEvent(new Event('change'));
                }
                if (settings.imageLayout !== undefined) {
                    imageLayout.value = settings.imageLayout;
                    imageLayout.dispatchEvent(new Event('change'));
                }
                if (settings.forceDesktopExport !== undefined) {
                    forceDesktopExport.checked = settings.forceDesktopExport;
                }
                if (settings.forceMobileExport !== undefined) {
                    forceMobileExport.checked = settings.forceMobileExport; // 新增
                }
                if (settings.paperDateVisible !== undefined) {
                    paperDateVisible.checked = settings.paperDateVisible;
                    paperDateVisible.dispatchEvent(new Event('change'));
                }
                
                // 新增：加载背景颜色设置
                if (settings.backgroundColor !== undefined) {
                    backgroundColor.value = settings.backgroundColor;
                    backgroundColor.dispatchEvent(new Event('input'));
                }
                if (settings.borderColor !== undefined) {
                    borderColor.value = settings.borderColor;
                    borderColor.dispatchEvent(new Event('input'));
                }
                
                // 新增：加载多栏布局设置
                if (settings.columnCount !== undefined) {
                    columnCount.value = settings.columnCount;
                    columnCount.dispatchEvent(new Event('input'));
                }
                if (settings.columnGap !== undefined) {
                    columnGap.value = settings.columnGap;
                    columnGap.dispatchEvent(new Event('input'));
                }
                
                // 报纸头部设置
                headerVisible.checked = settings.headerVisible;
                paperName.value = settings.paperName;
                paperNameFontSize.value = settings.paperNameFontSize;
                paperNameSizeValue.textContent = settings.paperNameFontSize;
                paperNameFontFamily.value = settings.paperNameFontFamily;
                updateFontPreview(paperNameFontPreview, settings.paperNameFontFamily);
                paperNameColor.value = settings.paperNameColor;
                paperNameColorValue.textContent = settings.paperNameColor;
                paperNameColorPreview.style.backgroundColor = settings.paperNameColor;
                
                paperDateText.value = settings.paperDateText;
                paperDateFontSize.value = settings.paperDateFontSize;
                paperDateSizeValue.textContent = settings.paperDateFontSize;
                paperDateFontFamily.value = settings.paperDateFontFamily;
                updateFontPreview(paperDateFontPreview, settings.paperDateFontFamily);
                paperDateColor.value = settings.paperDateColor;
                paperDateColorValue.textContent = settings.paperDateColor;
                paperDateColorPreview.style.backgroundColor = settings.paperDateColor;
                
                newspaperHeader.style.display = settings.headerVisible ? 'block' : 'none';
                
                // 标题样式设置
                articleTitle.value = settings.articleTitle;
                titleFontSize.value = settings.titleFontSize;
                titleSizeValue.textContent = settings.titleFontSize;
                titleFontFamily.value = settings.titleFontFamily;
                updateFontPreview(titleFontPreview, settings.titleFontFamily);
                titleColor.value = settings.titleColor;
                titleColorValue.textContent = settings.titleColor;
                titleColorPreview.style.backgroundColor = settings.titleColor;
                titleAlign.value = settings.titleAlign;
                
                // 正文样式设置
                articleContent.value = settings.articleContent;
                contentFontSize.value = settings.contentFontSize;
                contentSizeValue.textContent = settings.contentFontSize;
                contentFontFamily.value = settings.contentFontFamily;
                updateFontPreview(contentFontPreview, settings.contentFontFamily);
                contentColor.value = settings.contentColor;
                contentColorValue.textContent = settings.contentColor;
                contentColorPreview.style.backgroundColor = settings.contentColor;
                lineHeight.value = settings.lineHeight;
                lineHeightValue.textContent = settings.lineHeight;
                
                // 富文本内容
                if (settings.articleContentHTML) {
                    articleContentHTML = settings.articleContentHTML;
                    // 使用富文本内容更新预览
                    updatePreviewFromRichText(articleContentHTML);
                } else {
                    // 使用纯文本内容更新预览
                    updatePreviewFromText();
                }
                
                // 底部信息设置
                footerVisible.checked = settings.footerVisible;
                footerText.value = settings.footerText;
                footerFontSize.value = settings.footerFontSize;
                footerSizeValue.textContent = settings.footerFontSize;
                footerColor.value = settings.footerColor;
                footerColorValue.textContent = settings.footerColor;
                footerColorPreview.style.backgroundColor = settings.footerColor;
                newspaperFooter.style.display = settings.footerVisible ? 'block' : 'none';
                
                // 新增：底部日期显示/隐藏设置
                showFooterDate.checked = settings.showFooterDate !== undefined ? settings.showFooterDate : true;
                
                // 布局设置
                if (settings.layout === 'vertical') {
                    container.classList.add('vertical-layout');
                    verticalLayoutBtn.classList.add('active');
                    horizontalLayoutBtn.classList.remove('active');
                } else {
                    container.classList.remove('vertical-layout');
                    horizontalLayoutBtn.classList.add('active');
                    verticalLayoutBtn.classList.remove('active');
                }
                
                // 新增：加载富文本相关设置
                if (settings.uploadedImages) {
                    uploadedImages = settings.uploadedImages;
                    updateImagePreview();
                }
                
                if (settings.richTextContent) {
                    richTextEditor.innerHTML = settings.richTextContent;
                }
                
                // 更新预览
                updateNewspaper();
                showToast('设置已加载！');
            } catch (error) {
                console.error('加载设置时出错:', error);
                showToast('加载设置失败，数据可能已损坏！');
            }
        }
        
        // 应用所有样式的函数
        function applyAllStyles() {
            // 应用图片显示/隐藏
            articleImageContainer.style.display = imageVisible.checked ? 'block' : 'none';
            previewContent.classList.toggle('no-image', !imageVisible.checked);
            
            // 应用报纸头部显示/隐藏
            newspaperHeader.style.display = headerVisible.checked ? 'block' : 'none';
            
            // 应用报纸名称样式
            previewPaperName.textContent = paperName.value || "报纸名称";
            previewPaperName.style.fontSize = `${paperNameFontSize.value}px`;
            previewPaperName.style.fontFamily = paperNameFontFamily.value;
            previewPaperName.style.color = paperNameColor.value;
            
            // 应用报纸日期样式
            previewPaperDate.textContent = paperDateText.value || "日期信息";
            previewPaperDate.style.fontSize = `${paperDateFontSize.value}px`;
            previewPaperDate.style.fontFamily = paperDateFontFamily.value;
            previewPaperDate.style.color = paperDateColor.value;
            previewPaperDate.style.display = paperDateVisible.checked ? 'block' : 'none';
            
            // 应用标题样式
            previewTitle.textContent = articleTitle.value || "文章标题";
            previewTitle.style.fontSize = `${titleFontSize.value}px`;
            previewTitle.style.fontFamily = titleFontFamily.value;
            previewTitle.style.color = titleColor.value;
            previewTitle.style.textAlign = titleAlign.value;
            
            // 应用图片说明
            previewCaption.textContent = imageCaption.value || "图片说明";
            
            // 应用正文内容
            if (articleContentHTML) {
                // 使用富文本内容
                updatePreviewFromRichText(articleContentHTML);
            } else {
                // 使用纯文本内容
                updatePreviewFromText();
            }
            
            // 应用底部信息样式
            newspaperFooter.style.display = footerVisible.checked ? 'block' : 'none';
            updateFooterText();
            previewFooterText.style.fontSize = `${footerFontSize.value}px`;
            previewFooterText.style.color = footerColor.value;
            
            // 更新生成日期
            const now = new Date();
            const formattedDate = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日`;
            generationDate.textContent = formattedDate;
            
            // 应用噪点效果
            const paper = document.getElementById('newspaper');
            if (paperNoise.checked) paper.classList.add('has-noise');
            else paper.classList.remove('has-noise');
            
            // 应用图片布局
            articleContentDiv.classList.remove('layout-column', 'layout-row', 'layout-row-reverse');
            articleContentDiv.classList.add(`layout-${imageLayout.value}`);
            
            // 新增：应用背景颜色和边框颜色
            paper.style.backgroundColor = backgroundColor.value;
            paper.style.borderColor = borderColor.value;
            
            // 新增：应用多栏布局
            const articleText = document.querySelector('.article-text');
            if (articleText) {
                articleText.style.columnCount = columnCount.value;
                articleText.style.columnGap = `${columnGap.value}px`;
            }
        }
        
        // 更新报纸预览
        function updateNewspaper() {
            // 显示一个明显的视觉反馈
            const newspaperElement = document.getElementById('newspaper');
            const originalTransform = newspaperElement.style.transform;
            const originalBoxShadow = newspaperElement.style.boxShadow;
            
            // 添加动画效果
            newspaperElement.style.transform = 'scale(1.02)';
            newspaperElement.style.boxShadow = '0 0 30px rgba(140, 46, 46, 0.3)';
            
            setTimeout(() => {
                newspaperElement.style.transform = originalTransform;
                newspaperElement.style.boxShadow = originalBoxShadow;
            }, 300);
        }
        
        // 显示错误弹窗
        function showErrorModal(error, retryFunction) {
            errorDetails.innerHTML = `
                <p><strong>错误类型：</strong>${error.type || '未知错误'}</p>
                <p><strong>错误消息：</strong>${error.message || '未知错误消息'}</p>
                <p><strong>错误详情：</strong>${error.details || '无详细错误信息'}</p>
            `;
            
            errorSolution.innerHTML = `
                <li>检查网络连接是否正常</li>
                <li>尝试减小图片尺寸或分辨率</li>
                <li>关闭浏览器插件，特别是广告拦截器</li>
                <li>尝试使用不同的浏览器（推荐Chrome或Firefox）</li>
                <li>如果包含外部图片，请确保图片URL可访问</li>
                <li>尝试等待几分钟后重试</li>
            `;
            
            errorModal.style.display = 'flex';
            
            // 设置重试按钮功能
            retryBtn.onclick = function() {
                errorModal.style.display = 'none';
                if (retryFunction) {
                    retryFunction();
                }
            };
            
            closeErrorBtn.onclick = function() {
                errorModal.style.display = 'none';
            };
            
            // 点击模态框外部关闭
            errorModal.addEventListener('click', function(e) {
                if (e.target === errorModal) {
                    errorModal.style.display = 'none';
                }
            });
        }
        
        // 下载报纸为图片
        downloadBtn.addEventListener('click', function() {
            showToast('正在准备导出，请稍候...');
            
            const originalPaper = document.getElementById('newspaper');
            const isForceDesktop = forceDesktopExport.checked;
            const isForceMobile = forceMobileExport.checked;
            
            // 实现离屏渲染与 Blob 下载方案，解决手机端布局变窄及 Base64 限制问题
            let renderTarget = originalPaper;
            let tempContainer = null;

            if (isForceDesktop || isForceMobile) {
                // 创建隐藏的临时容器
                tempContainer = document.createElement('div');
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '0';
                
                // 克隆节点
                renderTarget = originalPaper.cloneNode(true);
                
                if (isForceDesktop) {
                    // 强制电脑版布局：固定宽度
                    tempContainer.style.width = '1200px';
                    renderTarget.style.width = '1200px';
                    renderTarget.style.height = 'auto';
                    
                    // 确保电脑版的多栏布局
                    const articleText = renderTarget.querySelector('.article-text');
                    if (articleText) {
                        articleText.style.columnCount = columnCount.value;
                        articleText.style.columnGap = `${columnGap.value}px`;
                    }
                } else if (isForceMobile) {
                    // 强制手机版布局：较窄宽度，单栏布局
                    tempContainer.style.width = '600px'; // 手机版较窄宽度
                    renderTarget.style.width = '600px';
                    renderTarget.style.height = 'auto';
                    
                    // 强制应用手机版样式
                    // 1. 文章内容改为单栏
                    const articleText = renderTarget.querySelector('.article-text');
                    if (articleText) {
                        articleText.style.columnCount = '1';
                        articleText.style.columnGap = '0';
                    }
                    
                    // 2. 调整标题和字体大小（模拟手机端）
                    const paperName = renderTarget.querySelector('.paper-name');
                    if (paperName) {
                        paperName.style.fontSize = '2.5rem'; // 手机端较小的字体
                    }
                    
                    const articleTitle = renderTarget.querySelector('.article-title');
                    if (articleTitle) {
                        articleTitle.style.fontSize = '2rem'; // 手机端较小的标题
                    }
                    
                    // 3. 确保图片和文字是上下布局（在手机端通常如此）
                    const articleContent = renderTarget.querySelector('.article-content');
                    if (articleContent) {
                        articleContent.style.flexDirection = 'column';
                    }
                    
                    // 4. 调整内边距
                    renderTarget.style.padding = '20px';
                    
                    // 5. 确保图片容器宽度100%
                    const articleImageContainer = renderTarget.querySelector('.article-image-container');
                    if (articleImageContainer) {
                        articleImageContainer.style.width = '100%';
                    }
                }
                
                tempContainer.appendChild(renderTarget);
                document.body.appendChild(tempContainer);
            }

            html2canvas(renderTarget, {
                backgroundColor: backgroundColor.value,
                scale: 2,
                useCORS: true,
                logging: false,
                width: isForceDesktop ? 1200 : (isForceMobile ? 600 : renderTarget.offsetWidth),
                onclone: function(clonedDoc) {
                    // 在克隆的文档中确保所有样式都被应用
                    const clonedNewspaper = clonedDoc.getElementById('newspaper');
                    if (clonedNewspaper) {
                        // 确保所有字体都已加载
                        clonedNewspaper.style.fontFamily = document.getElementById('newspaper').style.fontFamily;
                        
                        // 确保富文本样式被正确应用
                        const clonedContent = clonedNewspaper.querySelector('.article-text');
                        if (clonedContent) {
                            // 应用正文样式
                            clonedContent.style.fontSize = `${contentFontSize.value}px`;
                            clonedContent.style.fontFamily = contentFontFamily.value;
                            clonedContent.style.color = contentColor.value;
                            clonedContent.style.lineHeight = lineHeight.value;
                            
                            // 确保多栏布局正确应用
                            clonedContent.style.columnCount = columnCount.value;
                            clonedContent.style.columnGap = `${columnGap.value}px`;
                        }
                    }
                }
            }).then(canvas => {
                canvas.toBlob(function(blob) {
                    if (!blob) {
                        showToast('生成失败');
                        return;
                    }
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.download = `同人报纸-${new Date().getTime()}.png`;
                    link.href = url;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    // 清理工作
                    setTimeout(() => {
                        URL.revokeObjectURL(url);
                        if (tempContainer) document.body.removeChild(tempContainer);
                    }, 100);
                    
                    showToast('图片下载完成！');
                }, 'image/png');
            }).catch(err => {
                if (tempContainer) document.body.removeChild(tempContainer);
                console.error('导出出错:', err);
                
                // 显示错误弹窗
                let errorInfo = {
                    type: 'html2canvas错误',
                    message: err.message || '未知错误',
                    details: ''
                };
                
                // 根据错误类型提供更详细的错误信息
                if (err.message && err.message.includes('CORS')) {
                    errorInfo.details = '跨域资源共享(CORS)错误。这可能是因为图片来自不同的域，浏览器出于安全原因阻止了访问。';
                } else if (err.message && err.message.includes('tainted')) {
                    errorInfo.details = '画布被污染错误。这可能是因为使用了跨域图片，且图片服务器未设置正确的CORS头部。';
                } else if (err.message && err.message.includes('timeout')) {
                    errorInfo.details = '操作超时。生成过程花费了太长时间。';
                } else if (err.message && err.message.includes('memory')) {
                    errorInfo.details = '内存不足。报纸内容可能太复杂或图片太大。';
                }
                
                showErrorModal(errorInfo, function() {
                    // 重试函数
                    downloadBtn.click();
                });
            });
        });
        
        // 重置所有设置
        resetBtn.addEventListener('click', function() {
            if (confirm('确定要重置所有设置吗？这将清除所有自定义内容。')) {
                // 重置图片相关设置
                imageVisible.checked = true;
                articleImageContainer.style.display = 'block';
                previewContent.classList.remove('no-image');
                imageCaption.value = "上面可以插入图片，这里可以输入图片备注（当然吐槽碎碎念也没问题。";
                previewCaption.textContent = "上面可以插入图片，这里可以输入图片备注（当然吐槽碎碎念也没问题。";
                
                // 重置图片
                imagePreview.style.display = 'none';
                previewImage.src = "data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAwIiBoZWlnaHQ9IjQwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIiB2ZXJzaW9uPSIxLjEiPjxyZWN0IHdpZHRoPSI2MDAiIGhlaWdodD0iNDAwIiBmaWxsPSIjZjBmMGYwIi8+PHRleHQgeD0iMzAwIiB5PSIyMDAiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIyNCIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZmlsbD0iIzgwODA4MCI+UElDVFVSRSBQTEFDRUhPTERFUjwvdGV4dD48L3N2Zz4=";
                
                // 重置新增功能
                paperNoise.checked = false;
                imageLayout.value = 'row';
                forceDesktopExport.checked = true;
                forceMobileExport.checked = false; // 新增：手机版不选中
                paperDateVisible.checked = true;
                
                // 重置背景颜色
                backgroundColor.value = '#faf8f2';
                backgroundColor.dispatchEvent(new Event('input'));
                borderColor.value = '#d4c9b8';
                borderColor.dispatchEvent(new Event('input'));
                
                // 重置多栏布局
                columnCount.value = 2;
                columnCount.dispatchEvent(new Event('input'));
                columnGap.value = 30;
                columnGap.dispatchEvent(new Event('input'));
                
                // 重置报纸头部
                headerVisible.checked = true;
                newspaperHeader.style.display = 'block';
                paperName.value = "XX日报";
                previewPaperName.textContent = "XX日报";
                paperNameFontSize.value = 56;
                paperNameSizeValue.textContent = "56";
                previewPaperName.style.fontSize = "56px";
                paperNameFontFamily.value = "'Playfair Display', serif";
                updateFontPreview(paperNameFontPreview, paperNameFontFamily.value);
                previewPaperName.style.fontFamily = "'Playfair Display', serif";
                paperNameColor.value = "#222222";
                paperNameColorValue.textContent = "#222222";
                paperNameColorPreview.style.backgroundColor = "#222222";
                previewPaperName.style.color = "#222222";
                paperDateText.value = "第XXXX期 · XXXX专刊 · XXXX年XX月XX日（这里依然也是可以碎碎念，写'作者xxx'也可以，什么都行）";
                previewPaperDate.textContent = "第XXXX期 · XXXX专刊 · XXXX年XX月XX日（这里依然也是可以碎碎念，写'作者xxx'也可以，什么都行）";
                paperDateFontSize.value = 18;
                paperDateSizeValue.textContent = "18";
                previewPaperDate.style.fontSize = "18px";
                paperDateFontFamily.value = "'Noto Serif SC', serif";
                updateFontPreview(paperDateFontPreview, paperDateFontFamily.value);
                previewPaperDate.style.fontFamily = "'Noto Serif SC', serif";
                paperDateColor.value = "#666666";
                paperDateColorValue.textContent = "#666666";
                paperDateColorPreview.style.backgroundColor = "#666666";
                previewPaperDate.style.color = "#666666";
                
                // 重置标题样式
                articleTitle.value = "这里是文章标题";
                previewTitle.textContent = "这里是文章标题";
                titleFontSize.value = 48;
                titleSizeValue.textContent = "48";
                previewTitle.style.fontSize = "48px";
                titleFontFamily.value = "'Playfair Display', serif";
                updateFontPreview(titleFontPreview, titleFontFamily.value);
                previewTitle.style.fontFamily = "'Playfair Display', serif";
                titleColor.value = "#222222";
                titleColorValue.textContent = "#222222";
                titleColorPreview.style.backgroundColor = "#222222";
                previewTitle.style.color = "#222222";
                titleAlign.value = "center";
                previewTitle.style.textAlign = "center";
                
                // 重置正文样式
                articleContent.value = `总之这里就是正文了！
电脑上的预览是横屏输出的，输出也可以多栏式的排版，手机上似乎是默认竖着。

段落小标题示例
这是一个段落小标题的示例，可以在富文本编辑器中添加。

[图片]

在段落之间插入图片示例
这是图片上方的文字。

[图片]

这是图片下方的文字。`;
                
                // 重置富文本内容
                articleContentHTML = '';
                
                // 更新文章内容
                updatePreviewFromText();
                
                contentFontSize.value = 16;
                contentSizeValue.textContent = "16";
                previewContent.style.fontSize = "16px";
                contentFontFamily.value = "'Noto Serif SC', serif";
                updateFontPreview(contentFontPreview, contentFontFamily.value);
                previewContent.style.fontFamily = "'Noto Serif SC', serif";
                contentColor.value = "#333333";
                contentColorValue.textContent = "#333333";
                contentColorPreview.style.backgroundColor = "#333333";
                previewContent.style.color = "#333333";
                lineHeight.value = 1.6;
                lineHeightValue.textContent = "1.6";
                previewContent.style.lineHeight = "1.6";
                
                // 重置底部信息设置
                footerVisible.checked = true;
                newspaperFooter.style.display = 'block';
                footerText.value = "本报纸由「XX日报生成器」创建于";
                showFooterDate.checked = true;
                updateFooterText();
                footerFontSize.value = 14;
                footerSizeValue.textContent = "14";
                previewFooterText.style.fontSize = "14px";
                footerColor.value = "#666666";
                footerColorValue.textContent = "#666666";
                footerColorPreview.style.backgroundColor = "#666666";
                previewFooterText.style.color = "#666666";
                
                // 重置布局
                container.classList.remove('vertical-layout');
                horizontalLayoutBtn.classList.add('active');
                verticalLayoutBtn.classList.remove('active');
                
                // 重置富文本编辑器
                richTextEditor.innerHTML = '<p>在此处编辑文章内容...</p>';
                uploadedImages = [];
                updateImagePreview();
                
                // 更新生成日期
                const now = new Date();
                const formattedDate = `${now.getFullYear()}年${now.getMonth()+1}月${now.getDate()}日`;
                generationDate.textContent = formattedDate;
                
                // 应用所有样式并更新预览
                applyAllStyles();
                updateNewspaper();
                showToast('所有设置已重置！');
            }
        });
        
        // 显示提示消息
        function showToast(message) {
            toast.textContent = message;
            toast.style.display = 'block';
            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }
    </script>
</body>
</html>